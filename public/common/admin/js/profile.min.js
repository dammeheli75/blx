$(document).ready(function(){var a={NORMAL:1,VIPI:2,VIPII:3};$("#grid").kendoGrid({columns:[{field:"flag",title:"&nbsp;",width:"8px",template:function(b){switch(b.flag){case a.NORMAL:return"<span class='flag flag-success'></span>";case a.VIPI:return"<span class='flag flag-notice'></span>";case a.VIPII:return"<span class='flag flag-error'></span>";default:return"<span class='flag'></span>"}},attributes:{style:"padding: 0;"},editor:function(b,c){$('<input data-text-field="selectionTitle" data-value-field="selectionValue" data-bind="value:'+c.field+'"/>').appendTo(b).kendoDropDownList({optionLabel:"Loại hồ sơ",autoBind:false,dataSource:[{selectionTitle:"Thường",selectionValue:a.NORMAL},{selectionTitle:"VIP I",selectionValue:a.VIPI},{selectionTitle:"VIP II",selectionValue:a.VIPII}]})},filterable:false},{field:"profile_id",title:"ID",width:"60px",attributes:{style:"text-align: center;"},filterable:false,template:function(b){return'<a class="tooltip-cell" data-toggle="tooltip" title="Ngày tạo: '+b.time_created+'">'+b.profile_id+"</a>"}},{field:"name",title:"Họ và tên",width:"180px",template:function(b){return'<a class="tooltip-cell" data-toggle="tooltip" title="Năm sinh: '+kendo.toString(b.birthday,"dd/MM/yyyy")+'">'+b.name+"</a>"},filterable:{ui:function(b){b.kendoAutoComplete({dataSource:{transport:{read:{url:"http://localhost/BLX.VN/data/name-autocomplete.json",dataType:"json"}},schema:{data:function(c){return c.names||[]}}}})}}},{field:"birthday",title:"Năm sinh",template:'#= kendo.toString(birthday,"dd/MM/yyyy") #',editor:function(b,c){$('<input name="birthday" style="border-radius: 0" data-bind="value:'+c.field+'"/>').appendTo(b).kendoDatePicker({depth:"year",format:"dd/MM/yyyy"})},hidden:true},{field:"address",title:"Địa chỉ",width:"260px",filterable:false},{field:"phone",title:"Điện thoại",width:"135px",template:function(b){if(b.phone.onlySMS){return b.phone.number+"&nbsp;<sup>SMS</sup>"}return b.phone.number},editor:function(b,c){$('<input type="tel" class="k-input k-textbox" name="phone.number" required="" data-bind="'+c.field+'"><label class="checkbox only-sms">   <input type="checkbox" class="k-input k-checkbox" name="phone.onlySMS" data-bind="'+c.field+'">   Chỉ SMS</label>').appendTo(b)}},{field:"collaborator",title:"CTV",width:"110px",filterable:{ui:function(b){b.kendoDropDownList({autoBind:false,dataTextField:"title",dataValueField:"id",optionLabel:"Chọn CTV",dataSource:{transport:{read:{url:"http://localhost/BLX.VN/data/collaborator.json",dataType:"json"}},schema:{data:function(c){return c.collaborators||[]}}}})}},template:function(b){return b.collaborator.title},editor:function(b,c){$('<input data-text-field="title" data-value-field="id" data-bind="value:'+c.field+'"/>').appendTo(b).kendoDropDownList({optionLabel:"Cộng tác viên",autoBind:false,dataSource:{transport:{read:{url:"http://localhost/BLX.VN/data/collaborator.json",dataType:"json"}},schema:{data:function(d){return d.collaborators||[]}}}})}},{field:"test.date",title:"Ngày thi",width:"120px",filterable:false,attributes:{style:"text-align: center;"},format:"{0:dd/MM/yyyy}",template:function(b){if(b.test.date){return'<a class="tooltip-cell" data-toggle="tooltip" title="'+b.test.venue+'">'+kendo.toString(b.test.date,"dd/MM/yyyy")+"</a>"}else{return"--"}},editor:function(b,c){$('<input style="border-radius: 0" data-bind="value:'+c.field+'"/>').appendTo(b).kendoDatePicker({depth:"year",format:"dd/MM/yyyy"})}},{field:"test.venue",title:"Địa điểm thi",hidden:true,editor:function(b,c){$('<input data-bind="value:'+c.field+'"/>').appendTo(b).kendoDropDownList({optionLabel:"Chọn địa điểm",autoBind:false,dataTextField:"title",dataValueField:"value",dataSource:[{title:"--",value:null},{title:"Số 1 Quốc Tử Giám",value:1},{title:"101 Tô Vĩnh Diện",value:2}]})}},{field:"test.status",title:"Thi",filterable:false,width:"80px",template:function(b){switch(b.test.status){case 0:return"--";break;case 1:return"Trượt LT";break;case 2:return"Đạt";break;case 3:return"Vắng mặt";break;case 4:return"Trượt TH";break;default:return"";break}},editor:function(b,c){$('<input data-text-field="selectionTitle" data-value-field="selectionValue" data-bind="value:'+c.field+'"/>').appendTo(b).kendoDropDownList({optionLabel:"Kết quả thi",autoBind:false,dataSource:[{selectionTitle:"--",selectionValue:0},{selectionTitle:"Trượt lý thuyết",selectionValue:1},{selectionTitle:"Đạt",selectionValue:2},{selectionTitle:"Vắng mặt",selectionValue:3},{selectionTitle:"Trượt thực hành",selectionValue:4}]})}},{field:"license",title:"Bằng",width:"100px",filterable:false,attributes:{style:"text-align: center;"},template:function(b){if(b.license.front_50x32&&b.license.back_50x32){return'<img width="50" height="32" src="'+b.license.front_50x32+'" alt="Bằng lái xe của '+b.name+'">'}else{if(b.license.front_50x32&&!b.license.back_50x32){return'<img width="50" height="32" class="resource-notice" src="'+b.license.front_50x32+'" alt="Bằng lái xe của '+b.name+'" data-toggle="tooltip" title="Thiếu mặt sau">'}else{if(!b.license.front_50x32&&b.license.back_50x32){return'<img width="50" height="32" class="resource-notice" src="'+b.license.back_50x32+'" alt="Bằng lái xe của '+b.name+'" data-toggle="tooltip" title="Thiếu mặt trước">'}else{return"--"}}}},editor:function(b,c){$('<input name="license" type="hidden" data-bind="value:'+c.field+'"/>').appendTo(b)},sortable:false},{field:"note",title:"Ghi chú",editor:function(b,c){$('<input type="text" class="k-input k-textbox" name="note" data-bind="value:'+c.field+'"/>').appendTo(b)},filterable:false,sortable:false}],height:function(){return($(window).height()-66)+"px"},pageable:{info:false,pageSize:10},sortable:true,resizable:true,columnMenu:{columns:false,messages:{columns:"Chọn các cột",filter:"Thực hiện lọc",sortAscending:"Xếp tăng dần",sortDescending:"Xếp giảm dần"}},filterable:{extra:false,messages:{info:"Điều kiện lọc: ",filter:"Lọc",clear:"Xoá",isFalse:"False",isTrue:"True"},operators:{string:{contains:"Có chứa"},date:{gt:"Sau ngày",lt:"Trước ngày",eq:"Là ngày"}}},selectable:"row, multiple",editable:{mode:"popup",confirmation:false},dataSource:{transport:{read:{url:"http://localhost/BLX.VN/data/profile.json",type:"GET",dataType:"json"},create:{url:"http://localhost/BLX.VN/profile-create.php",type:"POST",dataType:"json"},update:{url:"http://localhost/BLX.VN/profile-update.php",type:"POST",dataType:"json"},destroy:{url:"http://localhost/BLX.VN/profile-destroy.php",type:"POST",dataType:"json"}},schema:{data:function(b){return b.profiles||[]},total:"total",model:{id:"profile_id",fields:{profile_id:{editable:false,nullable:false},flag:{defaultValue:1,nullable:false},name:{nullable:false,validation:{required:true}},birthday:{nullable:false,validation:{required:true}},address:{filterable:false,nullable:false,validation:{required:true}},phone:{onlySMS:{type:"boolean"},number:{nullable:false,validation:{required:true}}},test:{status:{nullable:true},venue:{nullable:true},date:{nullable:true}},collaborator:{id:{nullable:false},title:{type:"string"},validation:{required:true}},portrait:{portrait_75x100:{type:"string"},original:{type:"string"}},id_card:{front_original:{type:"string"},back_original:{type:"string"},front_150x100:{type:"string"},back_150x100:{type:"string"}},license:{front_original:{type:"string"},back_original:{type:"string"},front_50x32:{type:"string"},back_50x32:{type:"string"},front_150x100:{type:"string"},back_150x100:{type:"string"}},note:{type:"string"},time_created:{type:"string"}}}},serverFiltering:true,serverPaging:true,serverSorting:true,serverNavigation:true},toolbar:kendo.template($("#toolbarTemplate").html()),change:function(){var b=this;var d=b.select();var c=kendo.template($("#selectedActionsTemplate").html());$(".k-toolbar").find(".selected-actions").html(kendo.render(c,[{numberOfProfile:d.length}]));$(".selected-actions a.action-edit").click(function(){if(d.length==1){b.editRow(d[0])}return false});$(".selected-actions a.action-delete").click(function(){for(var e=0;e<d.length;e++){b.dataSource.remove(b.dataItem(d[e]))}b.dataSource.sync();return false})},dataBound:function(){var b=this;$("#grid").append(kendo.template($("#footerToolbarTemplate").html()));$(".footer-toolbar").width($(window).width()-$(".k-grid-pager").width()-31);$(".footer-toolbar").height($(".k-grid-pager").height()+16);$(".selected-actions a.action-add").click(function(){console.log("Add Action");b.addRow();return false});$(".k-grid-content tr[role='row']").dblclick(function(){b.editRow($(this));return false});$('[data-toggle="tooltip"]').tooltip({placement:"right"})},edit:function(h){var b=this;var g=h.model;var f=$(".k-edit-form-container > :lt(12)");var c=$(".k-edit-form-container > :gt(11):not(.k-edit-buttons)");f.wrapAll('<div class="first-column pull-left"/>');c.wrapAll('<div class="second-column pull-right"/>');$('[for="license"]').parent().hide();$(".k-edit-buttons").wrapAll('<div class="k-edit-buttons-wrapper"/>').before(kendo.template($("#resourceManagerTemplate").html()));var d={async:{saveUrl:"upload.php",removeUrl:"remove.php",autoUpload:true},multiple:false,localization:{cancel:"Huỷ",dropFilesHere:"Thả file",remove:"Xoá",retry:"Thử lại",select:"Chọn file",statusFailed:"Lỗi",statusUploaded:"Thành công",statusUploading:"Đang upload",uploadSelectedFiles:"Upload"},showFileList:false,success:function(j){var i=j.response;switch(this.name){case"portrait":g.set("portrait.portrait_75x100",i.image_url);$(".portrait .control-label .k-image img").attr("src",i.image_url);break;case"card-front":g.set("id_card.front_150x100",i.image_url);$(".card-front .control-label .k-image img").attr("src",i.image_url);break;case"card-back":g.set("id_card.back_150x100",i.image_url);$(".card-back .control-label .k-image img").attr("src",i.image_url);break;case"license-front":g.set("license.front_150x100",i.image_url);$(".license-front .control-label .k-image img").attr("src",i.image_url);break;case"license-back":g.set("license.back_150x100",i.image_url);$(".license-back .control-label .k-image img").attr("src",i.image_url);break}}};$(".uploader").kendoUpload(d);if(g.portrait.portrait_75x100){$(".portrait .control-label .k-image img").attr("src",g.portrait.portrait_75x100)}if(g.id_card.front_150x100){$(".card-front .control-label .k-image img").attr("src",g.id_card.front_150x100)}if(g.id_card.back_150x100){$(".card-back .control-label .k-image img").attr("src",g.id_card.back_150x100)}if(g.license.front_150x100){$(".license-front .control-label .k-image img").attr("src",g.license.front_150x100)}if(g.license.back_150x100){$(".license-back .control-label .k-image img").attr("src",g.license.back_150x100)}}});$(window).resize(function(){$("#grid").height(($(window).height()-66)+"px");$(".k-grid-content").height($("#grid").height()-109);$(".footer-toolbar").width($(window).width()-$(".k-grid-pager").width()-31)})});